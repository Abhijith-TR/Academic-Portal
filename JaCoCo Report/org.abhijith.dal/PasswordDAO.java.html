<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PasswordDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Tests in 'client' Coverage Results</a> &gt; <a href="index.source.html" class="el_package">org.abhijith.dal</a> &gt; <span class="el_source">PasswordDAO.java</span></div><h1>PasswordDAO.java</h1><pre class="source lang-java linenums">package org.abhijith.dal;

import java.io.InputStream;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.time.LocalDateTime;
import java.util.Properties;

public class PasswordDAO implements org.abhijith.daoInterfaces.PasswordDAO {
    private Connection databaseConnection;

    public Connection getDatabaseConnection() {
<span class="fc" id="L15">        return databaseConnection;</span>
    }

<span class="fc" id="L18">    public PasswordDAO() {</span>
        try {
            // Fetches the class loader and uses this to load the properties from the config file
<span class="fc" id="L21">            Properties databaseConfig = new Properties();</span>
<span class="fc" id="L22">            ClassLoader classLoader = PasswordDAO.class.getClassLoader();</span>
<span class="fc" id="L23">            InputStream inputStream = classLoader.getResourceAsStream( &quot;config.properties&quot; );</span>
<span class="fc" id="L24">            databaseConfig.load( inputStream );</span>

            // Establishes a connection with the database
<span class="fc" id="L27">            String connectionURL = databaseConfig.getProperty( &quot;connectionURL&quot; );</span>
<span class="fc" id="L28">            String username      = databaseConfig.getProperty( &quot;username&quot; );</span>
<span class="fc" id="L29">            String password      = databaseConfig.getProperty( &quot;password&quot; );</span>
<span class="fc" id="L30">            databaseConnection = DriverManager.getConnection(</span>
                    connectionURL,
                    username,
                    password
            );
<span class="nc" id="L35">        } catch ( Exception error ) {</span>
            // If the connection cannot be established, the system simply shuts down
<span class="nc" id="L37">            System.err.println( &quot;Configuration Error. Could not connect to database. Shutting down.&quot; );</span>
<span class="nc" id="L38">            System.exit( 0 );</span>
<span class="fc" id="L39">        }</span>
<span class="fc" id="L40">    }</span>

    public boolean authenticateUser( String id, String password, String role ) {
        try {
<span class="fc bfc" id="L44" title="All 6 branches covered.">            if ( id == null || password == null || role == null ) return false;</span>
<span class="fc" id="L45">            role = role.toUpperCase();</span>

            // Create a query to check whether there exists a user with this role and this id in the database
<span class="fc" id="L48">            PreparedStatement authenticationQuery = databaseConnection.prepareStatement( &quot;SELECT password FROM common_user_details WHERE id = ? AND role = ?&quot; );</span>
<span class="fc" id="L49">            authenticationQuery.setString( 1, id );</span>
<span class="fc" id="L50">            authenticationQuery.setString( 2, role );</span>
<span class="fc" id="L51">            ResultSet userDetails = authenticationQuery.executeQuery();</span>

            // If a row is returned, it means that there is such a user
<span class="fc bfc" id="L54" title="All 2 branches covered.">            if ( userDetails.next() ) {</span>
                // We get the password from the database and check whether this password matches the one that was given
<span class="fc" id="L56">                String  passwordInDatabase = userDetails.getString( 1 );</span>
<span class="fc" id="L57">                boolean passwordIsCorrect  = password.equals( passwordInDatabase );</span>

                // If the password matches the one that was given
<span class="fc bfc" id="L60" title="All 2 branches covered.">                if ( passwordIsCorrect ) {</span>
                    // Create a query to insert a log into the database
<span class="fc" id="L62">                    PreparedStatement insertLogQuery = databaseConnection.prepareStatement( &quot;INSERT INTO log VALUES(?, ?, ?, ?)&quot; );</span>
<span class="fc" id="L63">                    insertLogQuery.setString( 1, id );</span>
<span class="fc" id="L64">                    insertLogQuery.setString( 2, role );</span>
<span class="fc" id="L65">                    insertLogQuery.setObject( 3, LocalDateTime.now() );</span>
<span class="fc" id="L66">                    insertLogQuery.setString( 4, &quot;IN&quot; );</span>
<span class="fc" id="L67">                    int insertLogQueryResult = insertLogQuery.executeUpdate();</span>

                    // Returns to indicate that the log insertion was successful
                    // If the log insertion is unsuccessful, the user is not allowed to enter the application
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">                    return insertLogQueryResult != 0;</span>
                }
            }
<span class="fc" id="L74">            return false;</span>
<span class="fc" id="L75">        } catch ( Exception error ) {</span>
<span class="fc" id="L76">            System.out.println( error.getMessage() );</span>
<span class="fc" id="L77">            System.err.println( &quot;Database Error. Login failed&quot; );</span>
<span class="fc" id="L78">            return false;</span>
        }
    }

    public boolean logLogoutEntry( String id, String role ) {
        try {
<span class="fc bfc" id="L84" title="All 4 branches covered.">            if ( id == null || role == null ) return false;</span>
<span class="fc" id="L85">            role = role.toUpperCase();</span>

            // Create a query to insert the out entry of the user into the log table
<span class="fc" id="L88">            PreparedStatement logoutQuery = databaseConnection.prepareStatement( &quot;INSERT INTO log VALUES (?, ?, ?, ?)&quot; );</span>
<span class="fc" id="L89">            logoutQuery.setString( 1, id );</span>
<span class="fc" id="L90">            logoutQuery.setString( 2, role );</span>
<span class="fc" id="L91">            logoutQuery.setObject( 3, LocalDateTime.now() );</span>
<span class="fc" id="L92">            logoutQuery.setString( 4, &quot;OUT&quot; );</span>
<span class="fc" id="L93">            int logoutQueryResult = logoutQuery.executeUpdate();</span>

            // If the log entry insertion is unsuccessful, the user is not allowed to log out of the application
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">            return logoutQueryResult != 0;</span>
<span class="fc" id="L97">        } catch ( Exception error ) {</span>
<span class="fc" id="L98">            System.out.println( &quot;Database Error. Please wait&quot; );</span>
<span class="fc" id="L99">            return false;</span>
        }
    }

    @Override
    public boolean logoutPreviousUser() {
        try {
            // Get the last entry from the log
<span class="fc" id="L107">            PreparedStatement getLastLog       = databaseConnection.prepareStatement( &quot;SELECT id, role, in_or_out FROM log ORDER BY log_time DESC LIMIT 1&quot; );</span>
<span class="fc" id="L108">            ResultSet         getLastLogResult = getLastLog.executeQuery();</span>

            // Now check whether the in_or_out column is in or out
            // If the column is in, it means that the last user has not been logged out yet, and we have to log the user out
            // The only case in which we won't find an entry is if this user is the first entry into the database
<span class="fc" id="L113">            boolean isFirstEntry = getLastLogResult.next();</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">            if ( !isFirstEntry ) return true;</span>

<span class="fc" id="L116">            String id        = getLastLogResult.getString( 1 );</span>
<span class="fc" id="L117">            String role      = getLastLogResult.getString( 2 );</span>
<span class="fc" id="L118">            String in_or_out = getLastLogResult.getString( 3 );</span>

<span class="fc bfc" id="L120" title="All 2 branches covered.">            if ( in_or_out.equals( &quot;IN&quot; ) ) {</span>
                // Now we have to insert a new log into the database which says that the user has logged out
<span class="fc" id="L122">                PreparedStatement insertOutLog = databaseConnection.prepareStatement( &quot;INSERT INTO log VALUES ( ?, ?, ?, ?)&quot; );</span>
<span class="fc" id="L123">                insertOutLog.setString( 1, id );</span>
<span class="fc" id="L124">                insertOutLog.setString( 2, role );</span>
<span class="fc" id="L125">                insertOutLog.setObject( 3, LocalDateTime.now() );</span>
<span class="fc" id="L126">                insertOutLog.setString( 4, &quot;OUT&quot; );</span>

                // Returns true if the out entry was inserted successfully, returns false otherwise
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">                return insertOutLog.executeUpdate() == 1;</span>
            }
<span class="fc" id="L131">            return true;</span>
<span class="fc" id="L132">        } catch ( Exception error ) {</span>
<span class="fc" id="L133">            System.out.println( &quot;Database Error. Previous log not found&quot; );</span>
<span class="fc" id="L134">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>